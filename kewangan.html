<!DOCTYPE html>
<html lang="ms" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penyata Kewangan PIBG | SK Pulau Melayu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .tab-button {
            border-bottom-width: 2px;
            border-color: transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active-tab {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Make table text uppercase */
        table th, table td {
            text-transform: uppercase;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.3rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            margin: 0 0.125rem;
        }
        .action-btn:hover {
            opacity: 0.8;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .pagination-controls button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            background-color: #e2e8f0; /* slate-200 */
            font-weight: 500;
        }
        .pagination-controls button:hover:not(:disabled) {
            background-color: #cbd5e1; /* slate-300 */
        }
        .master-row {
            cursor: pointer;
            font-weight: 600;
            background-color: #f8fafc; /* slate-50 */
        }
        .master-row:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .detail-row {
            background-color: #ffffff;
        }
        .detail-row.hidden {
            display: none;
        }
        .detail-row td:first-child {
            padding-left: 2rem;
        }
        .icon-toggle {
            transition: transform 0.2s;
        }
        .master-row.expanded .icon-toggle {
            transform: rotate(90deg);
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-3">
                <img src="https://placehold.co/40x40/4f46e5/ffffff?text=SKPM" alt="Logo SK Pulau Melayu" class="h-10 w-10 rounded-md">
                <span class="text-xl font-bold text-slate-900">PIBG SK Pulau Melayu</span>
            </a>
            <div class="flex space-x-8">
                <a href="index.html" class="text-slate-600 hover:text-indigo-600 font-semibold">Kembali ke Laman Utama</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="flex justify-between items-start mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Penyata Kewangan PIBG</h1>
                <p class="mt-1 text-slate-500">Ringkasan aliran tunai dan perbelanjaan PIBG SK Pulau Melayu.</p>
            </div>
            <button id="open-settings-btn" class="p-2 rounded-md bg-slate-100 text-slate-600 hover:bg-slate-200" title="Tetapan Baki Awal">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>

        <div class="mb-6 border-b border-slate-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button data-tab="keseluruhan" class="tab-button active-tab whitespace-nowrap py-4 px-1 font-medium text-sm">Penyata Induk</button>
                <button data-tab="bank_islam" class="tab-button whitespace-nowrap py-4 px-1 font-medium text-sm text-slate-500 hover:text-slate-700">Bank Islam</button>
                <button data-tab="petty_cash" class="tab-button whitespace-nowrap py-4 px-1 font-medium text-sm text-slate-500 hover:text-slate-700">Dompet Tunai PIBG</button>
                <button data-tab="koperasi_mini" class="tab-button whitespace-nowrap py-4 px-1 font-medium text-sm text-slate-500 hover:text-slate-700">Koperasi Mini</button>
                <button data-tab="laporan" class="tab-button whitespace-nowrap py-4 px-1 font-medium text-sm text-slate-500 hover:text-slate-700">Pelaporan Tahunan</button>
            </nav>
        </div>

        <div id="tab-container">
            <div id="keseluruhan-content" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                        <p class="text-sm text-slate-500">BAKI AWAL TAHUN</p>
                        <p id="keseluruhan-baki-awal" class="text-2xl font-bold text-slate-900 mt-1">RM 0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                        <p class="text-sm text-slate-500">JUMLAH KUTIPAN</p>
                        <p id="keseluruhan-kutipan" class="text-2xl font-bold text-green-600 mt-1">RM 0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                        <p class="text-sm text-slate-500">JUMLAH PERBELANJAAN</p>
                        <p id="keseluruhan-perbelanjaan" class="text-2xl font-bold text-red-600 mt-1">RM 0.00</p>
                    </div>
                    <div class="bg-indigo-600 text-white p-6 rounded-lg shadow-lg">
                        <p class="text-sm text-indigo-200">BAKI AKHIR SEMASA</p>
                        <p id="keseluruhan-baki-akhir" class="text-2xl font-bold mt-1">RM 0.00</p>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                     <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">PENYATA INDUK (KESELURUHAN)</h2>
                        <div class="flex items-center space-x-4">
                            <div>
                                <label class="text-sm font-medium text-slate-700">PAPAR:</label>
                                <select name="limit-filter" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="10">10</option>
                                     <option value="20">20</option>
                                     <option value="30">30</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700">BULAN:</label>
                                <select name="month-filter" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="all">SEMUA</option><option value="0">JANUARI</option><option value="1">FEBRUARI</option><option value="2">MAC</option><option value="3">APRIL</option><option value="4">MEI</option><option value="5">JUN</option><option value="6">JULAI</option><option value="7">OGOS</option><option value="8">SEPTEMBER</option><option value="9">OKTOBER</option><option value="10">NOVEMBER</option><option value="11">DISEMBER</option>
                                </select>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-slate-700">TAHUN:</label>
                                <select name="year-filter" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="all">SEMUA</option>
                                </select>
                            </div>
                             <button data-action="export-pdf" title="Eksport ke PDF" class="p-2 mt-6 rounded-md bg-red-100 text-red-600 hover:bg-red-200">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm1 4a1 1 0 100 2h6a1 1 0 100-2H5zm0 4a1 1 0 100 2h3a1 1 0 100-2H5z"></path></svg>
                            </button>
                            <button data-action="export-excel" title="Eksport ke Excel" class="p-2 mt-6 rounded-md bg-green-100 text-green-600 hover:bg-green-200">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm9 4a1 1 0 011 1v1a1 1 0 01-2 0V7a1 1 0 011-1zm-2 4a1 1 0 01-1 1H7a1 1 0 110-2h3a1 1 0 011 1zm-1-3a1 1 0 10-2 0v1a1 1 0 102 0V7z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full w-full bg-white">
                            <thead class="bg-slate-200">
                                <tr>
                                    <th class="py-3 px-4 w-12"></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">BUTIRAN</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-slate-600 uppercase tracking-wider">JUMLAH MASUK (RM)</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-slate-600 uppercase tracking-wider">JUMLAH KELUAR (RM)</th>
                                </tr>
                            </thead>
                            <tbody id="keseluruhan-table" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                     <div data-id="pagination-controls" class="pagination-controls flex justify-between items-center mt-4"></div>
                </div>
            </div>

            <div id="account-tab-template" class="hidden">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                        <p class="text-sm text-slate-500">BAKI AWAL AKAUN</p>
                        <p data-id="baki-awal" class="text-2xl font-bold text-slate-900 mt-1">RM 0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                        <p class="text-sm text-slate-500">JUMLAH KUTIPAN</p>
                        <p data-id="kutipan" class="text-2xl font-bold text-green-600 mt-1">RM 0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                        <p class="text-sm text-slate-500">JUMLAH PERBELANJAAN</p>
                        <p data-id="perbelanjaan" class="text-2xl font-bold text-red-600 mt-1">RM 0.00</p>
                    </div>
                    <div class="bg-indigo-600 text-white p-6 rounded-lg shadow-lg">
                        <p class="text-sm text-indigo-200">BAKI AKHIR AKAUN</p>
                        <p data-id="baki-akhir" class="text-2xl font-bold mt-1">RM 0.00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                     <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                        <h2 data-id="table-title" class="text-2xl font-bold text-slate-800">BUTIRAN TRANSAKSI</h2>
                        <div class="flex items-center space-x-3">
                            <div>
                                <label class="text-sm font-medium text-slate-700">PAPAR:</label>
                                <select name="limit-filter" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="10">10</option>
                                     <option value="20">20</option>
                                     <option value="30">30</option>
                                </select>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-slate-700">BULAN:</label>
                                <select name="month-filter" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="all">SEMUA</option><option value="0">JANUARI</option><option value="1">FEBRUARI</option><option value="2">MAC</option><option value="3">APRIL</option><option value="4">MEI</option><option value="5">JUN</option><option value="6">JULAI</option><option value="7">OGOS</option><option value="8">SEPTEMBER</option><option value="9">OKTOBER</option><option value="10">NOVEMBER</option><option value="11">DISEMBER</option>
                                </select>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-slate-700">TAHUN:</label>
                                <select name="year-filter" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="all">SEMUA</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end items-center space-x-2 mb-4">
                        <button data-action="export-pdf" title="Eksport ke PDF" class="p-2 rounded-md bg-red-100 text-red-600 hover:bg-red-200 flex items-center space-x-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm1 4a1 1 0 100 2h6a1 1 0 100-2H5zm0 4a1 1 0 100 2h3a1 1 0 100-2H5z"></path></svg> <span>PDF</span></button>
                        <button data-action="export-excel" title="Eksport ke Excel" class="p-2 rounded-md bg-green-100 text-green-600 hover:bg-green-200 flex items-center space-x-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm9 4a1 1 0 011 1v1a1 1 0 01-2 0V7a1 1 0 011-1zm-2 4a1 1 0 01-1 1H7a1 1 0 110-2h3a1 1 0 011 1zm-1-3a1 1 0 10-2 0v1a1 1 0 102 0V7z"></path></svg> <span>EXCEL</span></button>
                        <button data-action="delete-selected" title="PADAM YANG DIPILIH" class="p-2 rounded-md bg-gray-300" disabled><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>
                        <button data-action="paste-excel" title="TAMPAL DARI EXCEL" class="p-2 rounded-md bg-blue-100 text-blue-600 hover:bg-blue-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7zm0 2h6v12H7V4zm4 2.5a.5.5 0 01.5.5v1a.5.5 0 01-1 0v-1a.5.5 0 01.5-.5zM8.5 9a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5zm0 2a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" clip-rule="evenodd" /></svg></button>
                        <button data-action="add-income" title="TAMBAH DUIT MASUK" class="p-2 rounded-md bg-green-100 text-green-600 hover:bg-green-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button>
                        <button data-action="add-expense" title="TAMBAH DUIT KELUAR" class="p-2 rounded-md bg-red-100 text-red-600 hover:bg-red-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full w-full bg-white">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="py-3 px-2 w-12 text-center"><input type="checkbox" data-action="select-all" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">TARIKH</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">BUTIRAN</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">MASUK (RM)</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">KELUAR (RM)</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">BAKI (RM)</th>
                                    <th class="py-3 px-4 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">TINDAKAN</th>
                                </tr>
                            </thead>
                            <tbody data-id="table-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                    <div data-id="pagination-controls" class="pagination-controls flex justify-between items-center mt-4"></div>
                </div>
            </div>
            
            <div id="laporan-content" class="tab-content p-6 md:p-8">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-slate-800">PELAPORAN TAHUNAN</h2>
                     <div class="flex items-center space-x-4">
                        <div>
                            <label for="report-start-date" class="text-sm font-medium text-slate-700">DARI:</label>
                            <input type="date" id="report-start-date" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        </div>
                        <div>
                            <label for="report-end-date" class="text-sm font-medium text-slate-700">HINGGA:</label>
                            <input type="date" id="report-end-date" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        </div>
                        <button id="print-report-btn" title="Cetak Penyata" class="p-2 mt-6 rounded-md bg-indigo-100 text-indigo-600 hover:bg-indigo-200">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="print-area" class="bg-white p-8 rounded-lg shadow-md border border-slate-200">
                    <div class="text-center mb-8">
                        <h3 id="report-title" class="text-xl font-bold text-slate-900 uppercase">PENYATA KEWANGAN PIBG SK PULAU MELAYU</h3>
                        <p id="report-date-range" class="text-slate-600"></p>
                    </div>

                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-2 text-slate-800 border-b pb-2 uppercase">PENDAPATAN</h4>
                        <table class="w-full text-sm border-collapse border border-slate-400">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border border-slate-300 text-left">BUTIRAN</th>
                                    <th class="py-2 px-4 border border-slate-300 text-right">JUMLAH (RM)</th>
                                </tr>
                            </thead>
                            <tbody id="income-report-table"></tbody>
                        </table>
                    </div>

                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-2 text-slate-800 border-b pb-2 uppercase">PERBELANJAAN</h4>
                        <table class="w-full text-sm border-collapse border border-slate-400">
                             <thead>
                                <tr>
                                    <th class="py-2 px-4 border border-slate-300 text-left">BUTIRAN</th>
                                    <th class="py-2 px-4 border border-slate-300 text-right">JUMLAH (RM)</th>
                                </tr>
                            </thead>
                            <tbody id="expense-report-table"></tbody>
                        </table>
                    </div>

                    <div class="mb-12">
                        <h4 class="text-lg font-semibold mb-2 text-slate-800 border-b pb-2 uppercase">RINGKASAN BAKI</h4>
                        <table class="w-full text-sm border-collapse border border-slate-400">
                            <tbody id="balance-summary-table"></tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-end pt-12">
                        <div class="grid grid-cols-2 gap-x-16 gap-y-12 text-sm text-center">
                            <div class="border-t border-slate-300 pt-2">
                                <p class="uppercase">(EN. TAIB ANAK BROWN)</p>
                                <p class="font-semibold">DISEDIAKAN OLEH, BENDAHARI</p>
                            </div>
                            <div class="border-t border-slate-300 pt-2">
                                <p class="uppercase">(EN. MUHD. FARHAN BIN SARKAWI)</p>
                                <p class="font-semibold">DISEMAK OLEH, YDP PIBG</p>
                            </div>
                             <div class="border-t border-slate-300 pt-2">
                                <p>(.................................................)</p>
                                <p class="font-semibold">DISAHKAN OLEH, JURUAUDIT 1</p>
                            </div>
                             <div class="border-t border-slate-300 pt-2">
                                <p>(.................................................)</p>
                                <p class="font-semibold">DISAHKAN OLEH, JURUAUDIT 2</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="transactionModal" class="fixed inset-0 z-[110] hidden items-center justify-center bg-black bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col" onclick="event.stopPropagation()">
            <form id="transactionForm">
                <div class="p-6 border-b">
                    <h3 id="modal-title" class="text-xl font-bold text-slate-800">TAMBAH TRANSAKSI</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="trans-date" class="block text-sm font-medium text-slate-700 mb-1">TARIKH</label>
                        <input type="date" id="trans-date" class="w-full px-3 py-2 border border-slate-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="trans-desc" class="block text-sm font-medium text-slate-700 mb-1">BUTIRAN</label>
                        <input type="text" id="trans-desc" class="w-full px-3 py-2 border border-slate-300 rounded-md" required>
                    </div>
                     <div>
                        <label for="trans-amount" class="block text-sm font-medium text-slate-700 mb-1">JUMLAH (RM)</label>
                        <input type="number" step="0.01" id="trans-amount" class="w-full px-3 py-2 border border-slate-300 rounded-md" required>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end items-center bg-slate-50 rounded-b-xl space-x-3">
                    <button type="button" id="cancel-trans-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">BATAL</button>
                    <button type="submit" id="save-trans-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">SIMPAN</button>
                </div>
            </form>
        </div>
    </div>

     <div id="settingsModal" class="fixed inset-0 z-[110] hidden items-center justify-center bg-black bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col" onclick="event.stopPropagation()">
            <form id="settingsForm">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold text-slate-800">TETAPAN BAKI AWAL TAHUN</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="baki-bank_islam" class="block text-sm font-medium text-slate-700 mb-1">BANK ISLAM (RM)</label>
                        <input type="number" step="0.01" id="baki-bank_islam" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="0" required>
                    </div>
                    <div>
                        <label for="baki-petty_cash" class="block text-sm font-medium text-slate-700 mb-1">TUNAI (DOMPET TUNAI) (RM)</label>
                        <input type="number" step="0.01" id="baki-petty_cash" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="0" required>
                    </div>
                     <div>
                        <label for="baki-koperasi_mini" class="block text-sm font-medium text-slate-700 mb-1">KOPERASI MINI (RM)</label>
                        <input type="number" step="0.01" id="baki-koperasi_mini" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="0" required>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end items-center bg-slate-50 rounded-b-xl space-x-3">
                    <button type="button" id="cancel-settings-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">BATAL</button>
                    <button type="submit" id="save-settings-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">SIMPAN TETAPAN</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="pasteModal" class="fixed inset-0 z-[110] hidden items-center justify-center bg-black bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col" onclick="event.stopPropagation()">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold text-slate-800">TAMPAL DATA DARI EXCEL</h3>
                <p class="text-sm text-slate-500 mt-1">PASTIKAN DATA ANDA MEMPUNYAI 4 LAJUR: TARIKH, BUTIRAN, MASUK, KELUAR</p>
            </div>
            <div class="p-6">
                <textarea id="paste-area" class="w-full h-64 p-2 border border-slate-300 rounded-md" placeholder="Tampal data dari Excel di sini..."></textarea>
            </div>
            <div class="p-4 border-t flex justify-end items-center bg-slate-50 rounded-b-xl space-x-3">
                <button type="button" id="cancel-paste-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">BATAL</button>
                <button type="button" id="process-paste-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">SIMPAN DATA</button>
            </div>
        </div>
    </div>


    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-6 py-6 text-center text-slate-500 text-sm">
            &copy; 2025 PERSATUAN IBU BAPA & GURU (PIBG) SK PULAU MELAYU. HAK CIPTA TERPELIHARA.
        </div>
    </footer>

    <div id="toast" class="fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-10 transition-all duration-300">
        <p id="toast-message"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pibgskpm-01';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCp-DmxgF1gckJQ24dkrRNVIPUSwADS7u4",
            authDomain: "pibgskpm-01.firebaseapp.com",
            projectId: "pibgskpm-01",
            storageBucket: "pibgskpm-01.appspot.com",
            messagingSenderId: "166309223339",
            appId: "1:166309223339:web:cbe72e17506b40820c90ee"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const transactionsCol = collection(db, `/artifacts/${appId}/public/data/transactions`);
        const settingsDoc = doc(db, `/artifacts/${appId}/public/data/settings/financials`);
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- State ---
            let allTransactions = [];
            let activeTab = 'keseluruhan';
            let BAKI_AWAL_TAHUN = { bank_islam: 0, petty_cash: 0, koperasi_mini: 0 };
            let paginationState = { keseluruhan: 1, bank_islam: 1, petty_cash: 1, koperasi_mini: 1 };
            const accountNames = { bank_islam: "BANK ISLAM", petty_cash: "DOMPET TUNAI", koperasi_mini: "KOPERASI MINI" };
            
            // --- UI Elements ---
            const tabContainer = document.getElementById('tab-container');
            const transactionModal = document.getElementById('transactionModal');
            const transactionForm = document.getElementById('transactionForm');
            const settingsModal = document.getElementById('settingsModal');
            const settingsForm = document.getElementById('settingsForm');
            const pasteModal = document.getElementById('pasteModal');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const reportStartDateInput = document.getElementById('report-start-date');
            const reportEndDateInput = document.getElementById('report-end-date');
            
            // --- General Functions ---
            const showToast = (message, type = 'success') => {
                toastMessage.textContent = message;
                toast.className = `fixed bottom-5 right-5 py-3 px-5 rounded-lg shadow-lg transition-all duration-300 ${type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-900 text-white'}`;
                toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
            };
            const openModal = (modal) => modal.classList.replace('hidden', 'flex');
            const closeModal = (modal) => modal.classList.replace('flex', 'hidden');
            const formatDateForInput = (date) => {
                const d = new Date(date);
                let month = '' + (d.getMonth() + 1);
                let day = '' + d.getDate();
                const year = d.getFullYear();
                if (month.length < 2) month = '0' + month;
                if (day.length < 2) day = '0' + day;
                return [year, month, day].join('-');
            };

            // --- Tab & UI Setup ---
            const setupTabs = () => {
                const template = document.getElementById('account-tab-template');
                Object.keys(accountNames).forEach(key => {
                    const clone = template.cloneNode(true);
                    clone.id = `${key}-content`;
                    clone.classList.add('tab-content');
                    clone.querySelector('[data-id="table-title"]').textContent = `Butiran Transaksi (${accountNames[key]})`;
                    tabContainer.appendChild(clone);
                });
            };
            
            const switchTabs = (tabId) => {
                activeTab = tabId;
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active-tab', btn.dataset.tab === tabId));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `${tabId}-content`));
                updateUI();
            };

            // --- Data & Calculation Logic ---
            const updateUI = () => {
                if(activeTab === 'laporan'){
                    renderAnnualReport();
                } else {
                    applyFiltersAndRender();
                }
                 updateBulkDeleteButtonState();
            };

            const calculateAndDisplayStats = (accountId, transactionsToProcess) => {
                let bakiAwal = (accountId === 'keseluruhan') 
                    ? Object.values(BAKI_AWAL_TAHUN).reduce((a, b) => a + b, 0)
                    : BAKI_AWAL_TAHUN[accountId] || 0;

                let totalIn = transactionsToProcess.reduce((sum, t) => sum + (t.type === 'masuk' ? t.amount : 0), 0);
                let totalOut = transactionsToProcess.reduce((sum, t) => sum + (t.type === 'keluar' ? t.amount : 0), 0);
                let bakiAkhir = bakiAwal + totalIn - totalOut;
                
                const formatCurrency = (num) => `RM ${num.toFixed(2)}`;

                if (accountId === 'keseluruhan') {
                    document.getElementById('keseluruhan-baki-awal').textContent = formatCurrency(bakiAwal);
                    document.getElementById('keseluruhan-kutipan').textContent = formatCurrency(totalIn);
                    document.getElementById('keseluruhan-perbelanjaan').textContent = formatCurrency(totalOut);
                    document.getElementById('keseluruhan-baki-akhir').textContent = formatCurrency(bakiAkhir);
                } else {
                    const contentEl = document.getElementById(`${accountId}-content`);
                    if(contentEl) {
                        contentEl.querySelector('[data-id="baki-awal"]').textContent = formatCurrency(bakiAwal);
                        contentEl.querySelector('[data-id="kutipan"]').textContent = formatCurrency(totalIn);
                        contentEl.querySelector('[data-id="perbelanjaan"]').textContent = formatCurrency(totalOut);
                        contentEl.querySelector('[data-id="baki-akhir"]').textContent = formatCurrency(bakiAkhir);
                    }
                }
            };
            
            const renderKeseluruhanTable = (groupedData) => {
                const tableBody = document.getElementById('keseluruhan-table');
                tableBody.innerHTML = '';
                if (Object.keys(groupedData).length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="4" class="py-10 text-center text-slate-500">TIADA TRANSAKSI.</td></tr>`;
                     return;
                }

                let groupIndex = 0;
                for (const [key, data] of Object.entries(groupedData)) {
                    const groupId = `group-${groupIndex++}`;
                    const masterRow = document.createElement('tr');
                    masterRow.className = 'master-row';
                    masterRow.dataset.groupId = groupId;
                    masterRow.innerHTML = `
                        <td class="py-3 px-4 text-center">
                            <svg class="w-4 h-4 text-slate-500 icon-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </td>
                        <td class="py-3 px-4">${key} (${data.transactions.length} REKOD)</td>
                        <td class="py-3 px-4 text-right text-green-600">${data.totalMasuk > 0 ? `+ ${data.totalMasuk.toFixed(2)}` : '-'}</td>
                        <td class="py-3 px-4 text-right text-red-600">${data.totalKeluar > 0 ? `- ${data.totalKeluar.toFixed(2)}` : '-'}</td>
                    `;
                    tableBody.appendChild(masterRow);

                    // Add sub-header for details
                    const subHeaderRow = document.createElement('tr');
                    subHeaderRow.className = 'detail-row hidden bg-slate-100 font-semibold';
                    subHeaderRow.dataset.groupId = groupId;
                    subHeaderRow.innerHTML = `
                        <td class="py-2 px-4 text-xs text-slate-500">TARIKH</td>
                        <td class="py-2 px-4 text-xs text-slate-500">AKAUN</td>
                        <td class="py-2 px-4 text-xs text-slate-500 text-right">MASUK (RM)</td>
                        <td class="py-2 px-4 text-xs text-slate-500 text-right">KELUAR (RM)</td>
                    `;
                    tableBody.appendChild(subHeaderRow);

                    data.transactions.forEach(t => {
                        const detailRow = document.createElement('tr');
                        detailRow.className = 'detail-row hidden';
                        detailRow.dataset.groupId = groupId;
                        detailRow.innerHTML = `
                            <td class="py-2 px-4">${t.timestamp.toDate().toLocaleDateString('ms-MY')}</td>
                            <td class="py-2 px-4">${accountNames[t.account] || t.account}</td>
                            <td class="py-2 px-4 text-right">${t.type === 'masuk' ? t.amount.toFixed(2) : '-'}</td>
                            <td class="py-2 px-4 text-right">${t.type === 'keluar' ? t.amount.toFixed(2) : '-'}</td>
                        `;
                        tableBody.appendChild(detailRow);
                    });
                }
            };


            const renderTable = (accountId, transactionsToRender) => {
                 if(accountId === 'keseluruhan') {
                     // The main render function now handles grouped data directly
                     return;
                 }
                const contentEl = document.getElementById(`${accountId}-content`);
                if(!contentEl) return;
                
                const tableBody = contentEl.querySelector('[data-id="table-body"]');
                tableBody.innerHTML = '';
                
                if (transactionsToRender.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="7" class="py-10 text-center text-slate-500">TIADA TRANSAKSI DIREKODKAN.</td></tr>`;
                     return;
                }
                const year = new Date().getFullYear();
                const bakiRow = `<tr class="bg-slate-50 font-semibold"><td class="px-2"></td><td class="py-3 px-4">01/01/${year}</td><td class="py-3 px-4" colspan="3">BAKI AWAL</td><td class="py-3 px-4 text-right">${(BAKI_AWAL_TAHUN[accountId] || 0).toFixed(2)}</td><td class="px-4"></td></tr>`;
                tableBody.innerHTML += bakiRow;

                let runningBalance = BAKI_AWAL_TAHUN[accountId] || 0;
                transactionsToRender.forEach(t => {
                    runningBalance += (t.type === 'masuk' ? t.amount : -t.amount);
                    const row = document.createElement('tr');
                    const isIncome = t.type === 'masuk';
                    row.className = isIncome ? 'bg-green-50/50' : 'bg-red-50/50';

                    row.innerHTML = `
                        <td class="py-3 px-2 text-center"><input type="checkbox" data-action="select-row" data-id="${t.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></td>
                        <td class="py-3 px-4 text-sm text-slate-500">${t.timestamp.toDate().toLocaleDateString('ms-MY')}</td>
                        <td class="py-3 px-4 text-sm font-medium text-slate-900">${t.description}</td>
                        <td class="py-3 px-4 text-sm text-green-600 text-right font-medium">${isIncome ? `+ ${t.amount.toFixed(2)}` : '-'}</td>
                        <td class="py-3 px-4 text-sm text-red-600 text-right font-medium">${!isIncome ? `- ${t.amount.toFixed(2)}` : '-'}</td>
                        <td class="py-3 px-4 text-sm font-semibold text-slate-800 text-right">${runningBalance.toFixed(2)}</td>
                        <td class="py-3 px-4 text-center">
                            <button data-action="edit" data-id="${t.id}" class="action-btn bg-yellow-100 text-yellow-700" title="KEMASKINI"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                            <button data-action="delete" data-id="${t.id}" class="action-btn bg-red-100 text-red-700" title="PADAM"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            };
            
            const applyFiltersAndRender = () => {
                const contentEl = document.getElementById(`${activeTab}-content`);
                if (!contentEl || activeTab === 'laporan') return;
                
                const selectedMonth = contentEl.querySelector('[name="month-filter"]').value;
                const selectedYear = contentEl.querySelector('[name="year-filter"]').value;
                const selectedLimit = parseInt(contentEl.querySelector('[name="limit-filter"]').value, 10);
                
                const filtered = allTransactions.filter(t => {
                    const appDate = t.timestamp.toDate();
                    const monthMatch = selectedMonth === 'all' || appDate.getMonth() == selectedMonth;
                    const yearMatch = selectedYear === 'all' || appDate.getFullYear() == selectedYear;
                    return monthMatch && yearMatch;
                }).sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
                
                calculateAndDisplayStats('keseluruhan', allTransactions);

                if (activeTab === 'keseluruhan') {
                    const grouped = filtered.reduce((acc, t) => {
                        const key = t.description.toLowerCase().trim();
                        if (!acc[key]) acc[key] = { transactions: [], totalMasuk: 0, totalKeluar: 0 };
                        acc[key].transactions.push(t);
                        if (t.type === 'masuk') acc[key].totalMasuk += t.amount;
                        else acc[key].totalKeluar += t.amount;
                        return acc;
                    }, {});

                    const currentPage = paginationState[activeTab] || 1;
                    const totalItems = Object.keys(grouped).length;
                    const totalPages = Math.ceil(totalItems / selectedLimit);
                    const startIndex = (currentPage - 1) * selectedLimit;
                    const paginatedGroupKeys = Object.keys(grouped).slice(startIndex, startIndex + selectedLimit);
                    const paginatedGroupedData = paginatedGroupKeys.reduce((acc, key) => {
                        acc[key] = grouped[key];
                        return acc;
                    }, {});
                    
                    renderKeseluruhanTable(paginatedGroupedData);
                    renderPaginationControls(currentPage, totalPages);
                } else {
                    const accountTransactions = filtered.filter(t => t.account === activeTab);
                    calculateAndDisplayStats(activeTab, accountTransactions);
                    
                    const currentPage = paginationState[activeTab] || 1;
                    const totalItems = accountTransactions.length;
                    const totalPages = Math.ceil(totalItems / selectedLimit);
                    const startIndex = (currentPage - 1) * selectedLimit;
                    const paginated = accountTransactions.slice(startIndex, startIndex + selectedLimit);

                    renderTable(activeTab, paginated);
                    renderPaginationControls(currentPage, totalPages);
                    updateBulkDeleteButtonState();
                }
            };

            const renderPaginationControls = (currentPage, totalPages) => {
                const contentEl = document.getElementById(`${activeTab}-content`);
                if (!contentEl) return;
                const controlsContainer = contentEl.querySelector('[data-id="pagination-controls"]');
                if (!controlsContainer) return;
                
                if (totalPages <= 1) {
                    controlsContainer.innerHTML = '';
                    return;
                }
                controlsContainer.innerHTML = `
                    <button data-action="prev-page" ${currentPage === 1 ? 'disabled' : ''}>SEBELUM</button>
                    <span class="text-sm font-medium text-slate-600">MUKA SURAT ${currentPage} DARI ${totalPages}</span>
                    <button data-action="next-page" ${currentPage === totalPages ? 'disabled' : ''}>SETERUSNYA</button>
                `;
            };
            
            const populateYearFilters = () => {
                const years = [...new Set(allTransactions.map(app => app.timestamp?.toDate().getFullYear()).filter(y => y))];
                if (years.length === 0) years.push(new Date().getFullYear());
                years.sort((a, b) => b - a);

                document.querySelectorAll('[name="year-filter"]').forEach(select => {
                     while(select.options.length > 1) { select.remove(1); }
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                });
            };

            const updateBulkDeleteButtonState = () => {
                 if(activeTab === 'keseluruhan' || activeTab === 'laporan') return;
                 const contentEl = document.getElementById(`${activeTab}-content`);
                 if(!contentEl) return;

                 const deleteBtn = contentEl.querySelector('[data-action="delete-selected"]');
                 const selectedCheckboxes = contentEl.querySelectorAll('[data-action="select-row"]:checked');

                 if(selectedCheckboxes.length > 0) {
                     deleteBtn.disabled = false;
                     deleteBtn.classList.remove('bg-gray-300');
                     deleteBtn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                     deleteBtn.setAttribute('title', `PADAM ${selectedCheckboxes.length} ITEM`);
                 } else {
                     deleteBtn.disabled = true;
                     deleteBtn.classList.add('bg-gray-300');
                     deleteBtn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                     deleteBtn.setAttribute('title', 'PADAM YANG DIPILIH');
                 }
            };
            
            // --- Annual Report Logic ---
            const renderAnnualReport = () => {
                const startDate = new Date(reportStartDateInput.value);
                const endDate = new Date(reportEndDateInput.value);
                if (!reportStartDateInput.value || !reportEndDateInput.value) return;

                document.getElementById('report-date-range').textContent = `BERMULA ${startDate.toLocaleDateString('ms-MY')} HINGGA ${endDate.toLocaleDateString('ms-MY')}`;
                
                const rangeTransactions = allTransactions.filter(t => {
                    const transDate = t.timestamp.toDate();
                    return transDate >= startDate && transDate <= endDate;
                });
                
                const incomeTable = document.getElementById('income-report-table');
                const expenseTable = document.getElementById('expense-report-table');
                const balanceTable = document.getElementById('balance-summary-table');
                const tableCellClasses = "py-2 px-4 border border-slate-300";
                const totalRowClasses = "font-bold border-t-2 border-slate-800";
                
                const groupTransactions = (transactions) => {
                    return transactions.reduce((acc, t) => {
                        const key = t.description.toLowerCase().trim();
                        if (!acc[key]) acc[key] = { description: t.description, total: 0 };
                        acc[key].total += t.amount;
                        return acc;
                    }, {});
                };

                // Populate Income
                let totalIncome = Object.values(BAKI_AWAL_TAHUN).reduce((a,b) => a + b, 0);
                incomeTable.innerHTML = `<tr><td class="${tableCellClasses}">BAKI AWAL TAHUN</td><td class="text-right ${tableCellClasses}">${totalIncome.toFixed(2)}</td></tr>`;
                const groupedIncome = groupTransactions(rangeTransactions.filter(t => t.type === 'masuk'));
                Object.values(groupedIncome).forEach(g => {
                    totalIncome += g.total;
                    incomeTable.innerHTML += `<tr><td class="${tableCellClasses}">${g.description}</td><td class="text-right ${tableCellClasses}">${g.total.toFixed(2)}</td></tr>`;
                });
                incomeTable.innerHTML += `<tr class="${totalRowClasses}"><td class="${tableCellClasses}">JUMLAH PENDAPATAN</td><td class="text-right ${tableCellClasses}">${totalIncome.toFixed(2)}</td></tr>`;

                // Populate Expenses
                let totalExpense = 0;
                expenseTable.innerHTML = '';
                const groupedExpense = groupTransactions(rangeTransactions.filter(t => t.type === 'keluar'));
                Object.values(groupedExpense).forEach(g => {
                    totalExpense += g.total;
                    expenseTable.innerHTML += `<tr><td class="${tableCellClasses}">${g.description}</td><td class="text-right ${tableCellClasses}">${g.total.toFixed(2)}</td></tr>`;
                });
                expenseTable.innerHTML += `<tr class="${totalRowClasses}"><td class="${tableCellClasses}">JUMLAH PERBELANJAAN</td><td class="text-right ${tableCellClasses}">${totalExpense.toFixed(2)}</td></tr>`;
                
                // Populate Balance Summary
                const bankIn = rangeTransactions.filter(t => t.account === 'bank_islam' && t.type === 'masuk').reduce((sum, t) => sum + t.amount, 0);
                const bankOut = rangeTransactions.filter(t => t.account === 'bank_islam' && t.type === 'keluar').reduce((sum, t) => sum + t.amount, 0);
                const bakiBank = (BAKI_AWAL_TAHUN['bank_islam'] || 0) + bankIn - bankOut;
                const tanganIn = rangeTransactions.filter(t => (t.account === 'petty_cash' || t.account === 'koperasi_mini') && t.type === 'masuk').reduce((sum, t) => sum + t.amount, 0);
                const tanganOut = rangeTransactions.filter(t => (t.account === 'petty_cash' || t.account === 'koperasi_mini') && t.type === 'keluar').reduce((sum, t) => sum + t.amount, 0);
                const bakiTangan = (BAKI_AWAL_TAHUN['petty_cash'] || 0) + (BAKI_AWAL_TAHUN['koperasi_mini'] || 0) + tanganIn - tanganOut;
                const jumlahBaki = bakiBank + bakiTangan;

                balanceTable.innerHTML = `
                    <tr><td class="${tableCellClasses}">BAKI DI BANK</td><td class="text-right ${tableCellClasses}">${bakiBank.toFixed(2)}</td></tr>
                    <tr><td class="${tableCellClasses}">BAKI DI TANGAN</td><td class="text-right ${tableCellClasses}">${bakiTangan.toFixed(2)}</td></tr>
                    <tr class="${totalRowClasses}"><td class="${tableCellClasses}">JUMLAH BAKI</td><td class="text-right ${tableCellClasses}">${jumlahBaki.toFixed(2)}</td></tr>`;
            };

            // --- Authentication & Initial Load ---
            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                    
                    const settingsSnap = await getDoc(settingsDoc);
                    if (settingsSnap.exists()) BAKI_AWAL_TAHUN = settingsSnap.data().bakiAwal;
                    
                    setupTabs();

                    onSnapshot(transactionsCol, (snapshot) => {
                        allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        populateYearFilters();
                        
                        const currentYear = new Date().getFullYear();
                        document.querySelectorAll('[name="year-filter"]').forEach(filter => {
                             const yearExists = Array.from(filter.options).some(opt => opt.value == currentYear);
                             if(yearExists) filter.value = currentYear;
                             else if (filter.options.length > 1) filter.value = filter.options[1].value;
                        });
                        
                        const year = new Date().getFullYear();
                        reportStartDateInput.value = `${year}-01-01`;
                        reportEndDateInput.value = `${year}-12-31`;
                        
                        updateUI();
                    });
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    showToast("Gagal menyambung ke pangkalan data.", 'error');
                }
            })();
            
            // --- Event Listeners ---
            document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => switchTabs(btn.dataset.tab)));
            
            tabContainer.addEventListener('change', e => {
                if (e.target.matches('[name="month-filter"], [name="year-filter"], [name="limit-filter"]')) {
                    paginationState[activeTab] = 1;
                    applyFiltersAndRender();
                }
            });

            tabContainer.addEventListener('click', async (e) => {
                const target = e.target;

                // Handle master row expand/collapse
                const masterRow = target.closest('.master-row');
                if(masterRow) {
                    const groupId = masterRow.dataset.groupId;
                    const detailRows = tabContainer.querySelectorAll(`.detail-row[data-group-id="${groupId}"]`);
                    masterRow.classList.toggle('expanded');
                    detailRows.forEach(row => row.classList.toggle('hidden'));
                    return;
                }

                if (target.matches('[data-action="select-all"]')) {
                    const contentEl = document.getElementById(`${activeTab}-content`);
                    const allCheckboxes = contentEl.querySelectorAll('[data-action="select-row"]');
                    allCheckboxes.forEach(cb => cb.checked = target.checked);
                    updateBulkDeleteButtonState();
                    return;
                }
                 if (target.matches('[data-action="select-row"]')) {
                    updateBulkDeleteButtonState();
                    return;
                }

                const actionBtn = target.closest('[data-action]');
                if (!actionBtn) return;
                
                const action = actionBtn.dataset.action;
                const id = actionBtn.dataset.id;
                
                switch(action) {
                    case 'prev-page':
                        if (paginationState[activeTab] > 1) {
                            paginationState[activeTab]--;
                            applyFiltersAndRender();
                        }
                        break;
                    case 'next-page':
                        paginationState[activeTab]++;
                        applyFiltersAndRender();
                        break;
                    case 'add-income':
                    case 'add-expense':
                        transactionForm.reset();
                        delete transactionForm.dataset.docId;
                        transactionForm.dataset.type = (action === 'add-income' ? 'masuk' : 'keluar');
                        document.getElementById('modal-title').textContent = (action === 'add-income' ? 'TAMBAH DUIT MASUK' : 'TAMBAH DUIT KELUAR');
                        document.getElementById('trans-date').value = formatDateForInput(new Date());
                        openModal(transactionModal);
                        break;
                    case 'paste-excel':
                        openModal(pasteModal);
                        break;
                    case 'edit': {
                        const trans = allTransactions.find(t => t.id === id);
                        if (trans) {
                            transactionForm.dataset.docId = id;
                            transactionForm.dataset.type = trans.type;
                            document.getElementById('modal-title').textContent = 'KEMASKINI TRANSAKSI';
                            document.getElementById('trans-date').value = formatDateForInput(trans.timestamp.toDate());
                            document.getElementById('trans-desc').value = trans.description;
                            document.getElementById('trans-amount').value = trans.amount;
                            openModal(transactionModal);
                        }
                        break;
                    }
                    case 'delete':
                        if (confirm(`ANDA PASTI MAHU PADAM TRANSAKSI INI?\nTINDAKAN INI TIDAK BOLEH DIBATALKAN.`)) {
                            try {
                                await deleteDoc(doc(db, transactionsCol.path, id));
                                showToast("Transaksi berjaya dipadam!");
                            } catch (error) {
                                showToast("Gagal memadam transaksi.", "error");
                            }
                        }
                        break;
                    case 'delete-selected': {
                        const contentEl = document.getElementById(`${activeTab}-content`);
                        const selectedCheckboxes = contentEl.querySelectorAll('[data-action="select-row"]:checked');
                        const idsToDelete = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
                        if (idsToDelete.length === 0) return;

                        if (confirm(`ANDA PASTI MAHU PADAM ${idsToDelete.length} TRANSAKSI YANG DIPILIH?\nTINDAKAN INI TIDAK BOLEH DIBATALKAN.`)) {
                            try {
                                const batch = writeBatch(db);
                                idsToDelete.forEach(docId => batch.delete(doc(db, transactionsCol.path, docId)));
                                await batch.commit();
                                showToast(`${idsToDelete.length} transaksi berjaya dipadam!`);
                            } catch(error) {
                                showToast("Gagal memadam transaksi terpilih.", "error");
                            }
                        }
                        break;
                    }
                    case 'export-pdf':
                    case 'export-excel':
                        handleExport(action);
                        break;
                }
            });
            
            const handleExport = (type) => {
                const contentEl = document.getElementById(`${activeTab}-content`);
                if (!contentEl) return;
                
                const selectedMonth = contentEl.querySelector('[name="month-filter"]').value;
                const selectedYear = contentEl.querySelector('[name="year-filter"]').value;

                const filteredData = allTransactions.filter(t => {
                    if (activeTab !== 'keseluruhan' && t.account !== activeTab) return false;
                    const appDate = t.timestamp.toDate();
                    const monthMatch = selectedMonth === 'all' || appDate.getMonth() == selectedMonth;
                    const yearMatch = selectedYear === 'all' || appDate.getFullYear() == selectedYear;
                    return monthMatch && yearMatch;
                }).sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                
                const title = `Penyata Kewangan - ${accountNames[activeTab] || 'Keseluruhan'}`;
                const filename = `penyata-${activeTab}-${new Date().toISOString().slice(0,10)}`;

                if (type === 'export-pdf') {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text(title, 14, 15);
                    const head = activeTab === 'keseluruhan' ? [['TARIKH', 'BUTIRAN', 'AKAUN', 'MASUK (RM)', 'KELUAR (RM)']] : [['TARIKH', 'BUTIRAN', 'MASUK (RM)', 'KELUAR (RM)', 'BAKI (RM)']];
                    let baki = BAKI_AWAL_TAHUN[activeTab] || 0;
                    const body = filteredData.map(t => {
                        if (activeTab === 'keseluruhan') {
                            return [t.timestamp.toDate().toLocaleDateString('ms-MY'), t.description, accountNames[t.account] || t.account, t.type === 'masuk' ? t.amount.toFixed(2): '', t.type==='keluar' ? t.amount.toFixed(2):''];
                        } else {
                            baki += (t.type === 'masuk' ? t.amount : -t.amount);
                            return [t.timestamp.toDate().toLocaleDateString('ms-MY'), t.description, t.type === 'masuk' ? t.amount.toFixed(2) : '', t.type === 'keluar' ? t.amount.toFixed(2) : '', baki.toFixed(2)];
                        }
                    });
                    doc.autoTable({ head, body, startY: 20, headStyles: { fillColor: [79, 70, 229] } });
                    doc.save(`${filename}.pdf`);

                } else if (type === 'export-excel') {
                    let baki = BAKI_AWAL_TAHUN[activeTab] || 0;
                    const dataForExport = filteredData.map(t => {
                         if (activeTab === 'keseluruhan') {
                             return { TARIKH: t.timestamp.toDate().toLocaleDateString('ms-MY'), BUTIRAN: t.description, AKAUN: accountNames[t.account] || t.account, 'MASUK (RM)': t.type === 'masuk' ? t.amount : '', 'KELUAR (RM)': t.type === 'keluar' ? t.amount : '' };
                         } else {
                             baki += (t.type === 'masuk' ? t.amount : -t.amount);
                             return { TARIKH: t.timestamp.toDate().toLocaleDateString('ms-MY'), BUTIRAN: t.description, 'MASUK (RM)': t.type === 'masuk' ? t.amount : '', 'KELUAR (RM)': t.type === 'keluar' ? t.amount : '', 'BAKI (RM)': baki };
                         }
                    });
                    const ws = XLSX.utils.json_to_sheet(dataForExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, accountNames[activeTab] || 'Keseluruhan');
                    XLSX.writeFile(wb, `${filename}.xlsx`);
                }
            };

            document.getElementById('cancel-trans-btn').addEventListener('click', () => closeModal(transactionModal));
            transactionModal.addEventListener('click', (e) => { if(e.target === transactionModal) closeModal(transactionModal); });

            transactionForm.addEventListener('submit', async e => {
                e.preventDefault();
                const docId = transactionForm.dataset.docId;
                const formData = {
                    account: activeTab,
                    type: transactionForm.dataset.type,
                    description: document.getElementById('trans-desc').value,
                    amount: parseFloat(document.getElementById('trans-amount').value),
                    timestamp: Timestamp.fromDate(new Date(document.getElementById('trans-date').value))
                };
                
                try {
                    if (docId) await updateDoc(doc(db, transactionsCol.path, docId), formData), showToast("Transaksi berjaya dikemaskini!");
                    else await addDoc(transactionsCol, formData), showToast("Transaksi berjaya disimpan!");
                    transactionForm.reset();
                    closeModal(transactionModal);
                } catch(error) { showToast("Gagal menyimpan transaksi.", "error"); }
            });
            
            document.getElementById('open-settings-btn').addEventListener('click', () => {
                Object.keys(BAKI_AWAL_TAHUN).forEach(key => document.getElementById(`baki-${key}`).value = BAKI_AWAL_TAHUN[key]);
                openModal(settingsModal);
            });

            document.getElementById('cancel-settings-btn').addEventListener('click', () => closeModal(settingsModal));
            settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) closeModal(settingsModal); });
            settingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newBalances = {
                    bank_islam: parseFloat(document.getElementById('baki-bank_islam').value) || 0,
                    petty_cash: parseFloat(document.getElementById('baki-petty_cash').value) || 0,
                    koperasi_mini: parseFloat(document.getElementById('baki-koperasi_mini').value) || 0,
                };
                try {
                    await setDoc(settingsDoc, { bakiAwal: newBalances });
                    BAKI_AWAL_TAHUN = newBalances;
                    updateUI();
                    showToast("Baki awal berjaya dikemaskini!");
                    closeModal(settingsModal);
                } catch (error) { showToast("Gagal menyimpan tetapan.", "error"); }
            });
            
            reportStartDateInput.addEventListener('change', renderAnnualReport);
            reportEndDateInput.addEventListener('change', renderAnnualReport);
            document.getElementById('print-report-btn').addEventListener('click', () => {
                 const style = `<style>
                    body { font-family: 'Inter', sans-serif; -webkit-print-color-adjust: exact; text-transform: uppercase;} table { width: 100%; border-collapse: collapse; }
                    td, th { border: 1px solid #9ca3af; padding: 8px; font-size: 11px; } h3, h4, p { margin-bottom: 1rem; text-align: center; }
                    h3 { font-size: 1.25rem; font-weight: bold; } h4 { text-align: left; border-bottom: 1px solid #333; padding-bottom: 4px; font-size: 1rem; font-weight: 600; margin-top: 2rem;}
                    .text-right { text-align: right; } .text-left { text-align: left; } .font-bold { font-weight: bold; } .border-t-2 { border-top-width: 2px; } .border-slate-800 { border-color: #1e293b; }
                    .grid { display: grid; } .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } .gap-x-16 { column-gap: 4rem; } .gap-y-12 { row-gap: 3rem; } .pt-12 { padding-top: 3rem; }
                    .pt-2 { padding-top: 0.5rem; } .border-t { border-top-width: 1px; } .border-slate-300 { border-color: #d1d5db; } .justify-end { justify-content: flex-end; } .flex { display: flex; } .text-center { text-align: center; }
                 </style>`;
                 const printWindow = window.open('', '', 'height=800,width=800');
                 printWindow.document.write(`<html><head><title>Penyata Kewangan Tahunan</title>${style}</head><body>${document.getElementById('print-area').innerHTML}</body></html>`);
                 printWindow.document.close();
                 printWindow.focus();
                 setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
            });

            document.getElementById('cancel-paste-btn').addEventListener('click', () => closeModal(pasteModal));
            pasteModal.addEventListener('click', (e) => { if(e.target === pasteModal) closeModal(pasteModal); });
            document.getElementById('process-paste-btn').addEventListener('click', async () => {
                const pasteArea = document.getElementById('paste-area');
                const rows = pasteArea.value.split('\n').filter(row => row.trim() !== '');
                let successCount = 0;
                for (const row of rows) {
                    const [dateStr, desc, incomeStr, expenseStr] = row.split('\t');
                    const income = parseFloat(incomeStr) || 0;
                    const expense = parseFloat(expenseStr) || 0;
                    const amount = income > 0 ? income : expense;
                    
                    if (amount > 0 && desc && dateStr) {
                        try {
                             await addDoc(transactionsCol, { account: activeTab, type: income > 0 ? 'masuk' : 'keluar', description: desc.trim(), amount: amount, timestamp: Timestamp.fromDate(new Date(dateStr)) });
                            successCount++;
                        } catch(e) { console.error("Error processing row: ", row, e); }
                    }
                }
                showToast(`${successCount} transaksi berjaya diimport!`);
                pasteArea.value = '';
                closeModal(pasteModal);
            });
        });
    </script>
</body>
</html>
