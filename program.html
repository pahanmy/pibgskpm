<!DOCTYPE html>
<html lang="ms" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program PIBG | PIBG SK Pulau Melayu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .nav-link { position: relative; transition: color 0.3s ease; }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -4px; left: 50%; transform: translateX(-50%); background-color: #4f46e5; transition: width 0.3s ease; }
        .nav-link:hover::after, .nav-link.active::after { width: 100%; }
        .gradient-text { background: linear-gradient(to right, #4f46e5, #0ea5e9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-tiada { background-color: #f3f4f6; color: #4b5563; }
        .status-baru, .status-dalam-proses { background-color: #e0e7ff; color: #3730a3; }
        .status-lulus, .status-diluluskan { background-color: #d1fae5; color: #065f46; }
        .status-tolak, .status-ditolak { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
             <a href="index.html" class="flex items-center space-x-3">
                <img src="https://placehold.co/40x40/4f46e5/ffffff?text=SKPM" alt="Logo SK Pulau Melayu" class="h-10 w-10 rounded-md">
                <span class="text-xl font-bold text-slate-900">PIBG SK Pulau Melayu</span>
            </a>
            <div class="hidden md:flex space-x-8">
                <a href="index.html" class="nav-link text-slate-600 hover:text-indigo-600">Utama</a>
                <a href="program.html" class="nav-link text-slate-600 hover:text-indigo-600 active">Program</a>
                <a href="semak.html" class="nav-link text-slate-600 hover:text-indigo-600">Peruntukan</a>
                <a href="index.html#hubungi-kami" class="nav-link text-slate-600 hover:text-indigo-600">Hubungi Kami</a>
            </div>
             <div class="md:hidden"><button id="mobile-menu-button" class="text-slate-600">Menu</button></div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-16">
        <div class="flex flex-col md:flex-row justify-between md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold gradient-text">Takwim & Program PIBG</h1>
                <p class="mt-2 text-lg text-slate-600">Daftar dan pantau semua aktiviti anjuran atau yang melibatkan PIBG.</p>
            </div>
            <button id="addProgramBtn" class="flex-shrink-0 flex items-center justify-center space-x-2 px-5 py-2.5 bg-slate-800 text-white font-semibold rounded-lg hover:bg-slate-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span>Tambah Program</span>
            </button>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="py-3 px-5 text-left text-xs font-semibold uppercase">Bil.</th>
                            <th class="py-3 px-5 text-left text-xs font-semibold uppercase">Nama Program</th>
                            <th class="py-3 px-5 text-left text-xs font-semibold uppercase">Jenis</th>
                            <th class="py-3 px-5 text-left text-xs font-semibold uppercase">Tarikh</th>
                            <th class="py-3 px-5 text-center text-xs font-semibold uppercase">Status Peruntukan</th>
                        </tr>
                    </thead>
                    <tbody id="programsListBody" class="divide-y divide-slate-200">
                        <tr><td colspan="5" class="text-center p-10 text-slate-500">Memuatkan data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="choiceModal" class="fixed inset-0 z-[110] hidden items-center justify-center bg-black bg-opacity-70">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 text-center">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Jenis Program Baharu</h3>
            <p class="text-slate-600 mb-8">Adakah program yang ingin didaftarkan ini memerlukan peruntukan kewangan daripada PIBG?</p>
            <div class="flex justify-center gap-4">
                <button id="choice-yes" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Ya, Perlu Peruntukan</button>
                <button id="choice-no" class="w-full px-6 py-3 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300">Tidak Perlu</button>
            </div>
        </div>
    </div>
    
    <div id="programModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl" onclick="event.stopPropagation()">
            <div class="p-6 border-b"><h3 class="text-2xl font-bold">Daftar Program (Tanpa Peruntukan)</h3></div>
            <div class="p-8"><form id="programForm" class="space-y-6">
                <div>
                    <label for="prog-nama">Nama Program <span class="text-red-600">*</span></label>
                    <input type="text" id="prog-nama" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                </div>
                <div>
                    <label for="prog-jenis">Jenis Program <span class="text-red-600">*</span></label>
                    <select id="prog-jenis" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                       <option value="">-- Sila Pilih --</option>
                       <option value="Program Khas">Program Khas</option>
                       <option value="Mesyuarat">Mesyuarat</option>
                       <option value="Lawatan">Lawatan</option>
                       <option value="Gotong-Royong">Gotong-Royong</option>
                    </select>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="prog-tarikh-mula">Tarikh Mula <span class="text-red-600">*</span></label>
                        <input type="date" id="prog-tarikh-mula" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="prog-tarikh-akhir">Tarikh Akhir (Jika lebih sehari)</label>
                        <input type="date" id="prog-tarikh-akhir" class="w-full mt-1 px-3 py-2 border rounded-md">
                    </div>
                </div>
                <div class="pt-4 flex justify-end gap-4">
                    <button type="button" id="cancelProgramBtn" class="px-6 py-2 bg-slate-200 rounded-md">Batal</button>
                    <button type="submit" class="px-6 py-2 bg-slate-700 text-white rounded-md">Simpan Program</button>
                </div>
            </form></div>
        </div>
    </div>

    <footer class="bg-white border-t mt-16"><div class="container mx-auto p-6 text-center text-sm">&copy; 2025 PIBG SK Pulau Melayu.</div></footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pibgskpm-01';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCp-DmxgF1gckJQ24dkrRNVIPUSwADS7u4",
            authDomain: "pibgskpm-01.firebaseapp.com",
            projectId: "pibgskpm-01",
            storageBucket: "pibgskpm-01.appspot.com",
            messagingSenderId: "166309223339",
            appId: "1:166309223339:web:cbe72e17506b40820c90ee"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Collection References ---
        const programsCol = collection(db, "pibg_programs");
        const applicationsCol = collection(db, `/artifacts/${appId}/public/data/applications`);

        // --- UI Elements ---
        const addProgramBtn = document.getElementById('addProgramBtn');
        const choiceModal = document.getElementById('choiceModal');
        const choiceYesBtn = document.getElementById('choice-yes');
        const choiceNoBtn = document.getElementById('choice-no');
        const programModal = document.getElementById('programModal');
        const programForm = document.getElementById('programForm');
        const cancelProgramBtn = document.getElementById('cancelProgramBtn');
        const programsListBody = document.getElementById('programsListBody');

        // --- State Variables ---
        let programsFromPrograms = [];
        let programsFromApplications = [];

        // --- Authentication & Initial Load ---
        (async () => { 
            try { 
                await signInAnonymously(auth); 
                listenForData(); 
            } catch (e) { 
                console.error("Authentication failed:", e); 
                programsListBody.innerHTML = `<tr><td colspan="5" class="text-center p-10 text-red-500">Gagal menyambung ke pangkalan data.</td></tr>`;
            } 
        })();

        // --- Event Listeners ---
        addProgramBtn.addEventListener('click', () => choiceModal.classList.replace('hidden', 'flex'));
        choiceModal.addEventListener('click', () => choiceModal.classList.replace('flex', 'hidden'));

        choiceYesBtn.addEventListener('click', () => window.location.href = 'semak.html');
        
        choiceNoBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            choiceModal.classList.replace('flex', 'hidden');
            programForm.reset();
            programModal.classList.replace('hidden', 'flex');
        });

        cancelProgramBtn.addEventListener('click', () => programModal.classList.replace('flex', 'hidden'));

        programForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            try {
                await addDoc(programsCol, {
                    name: document.getElementById('prog-nama').value,
                    type: document.getElementById('prog-jenis').value,
                    startDate: document.getElementById('prog-tarikh-mula').value,
                    endDate: document.getElementById('prog-tarikh-akhir').value || null,
                    requiresFunding: false,
                    fundingStatus: 'Tidak Berkaitan',
                    createdAt: serverTimestamp()
                });
                programModal.classList.replace('flex', 'hidden');
                // No need for alert, onSnapshot will update the list automatically.
            } catch (error) { 
                console.error("Error adding program:", error); 
                alert("Gagal menyimpan program."); 
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Program';
            }
        });

        // --- Data Fetching and Rendering ---
        const renderCombinedPrograms = () => {
            const allPrograms = [...programsFromPrograms, ...programsFromApplications];
            
            // Sort by start date, most recent first
            allPrograms.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            programsListBody.innerHTML = '';
            if (allPrograms.length === 0) {
                programsListBody.innerHTML = `<tr><td colspan="5" class="text-center p-10">Belum ada sebarang program yang didaftarkan.</td></tr>`;
                return;
            }

            allPrograms.forEach((prog, index) => {
                let date = prog.startDate ? new Date(prog.startDate + 'T00:00:00').toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric'}) : 'Tiada Tarikh';
                if (prog.endDate) date += ` - ${new Date(prog.endDate + 'T00:00:00').toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric'})}`;
                
                let statusText = prog.fundingStatus || 'N/A';
                let statusClass = `status-${statusText.toLowerCase().replace(/\s+/g, '-')}`;
                
                const row = `
                    <tr class="hover:bg-slate-50 transition-colors duration-200">
                        <td class="py-4 px-5 text-sm text-slate-500">${index + 1}</td>
                        <td class="py-4 px-5 font-medium text-slate-800">${prog.name}</td>
                        <td class="py-4 px-5 text-sm text-slate-600">${prog.type}</td>
                        <td class="py-4 px-5 text-sm text-slate-600">${date}</td>
                        <td class="py-4 px-5 text-center"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>`;
                programsListBody.innerHTML += row;
            });
        };

        const listenForData = () => {
            // Listener for programs without funding
            const qPrograms = query(programsCol, orderBy("createdAt", "desc"));
            onSnapshot(qPrograms, (snapshot) => {
                programsFromPrograms = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.name,
                        type: data.type,
                        startDate: data.startDate,
                        endDate: data.endDate,
                        fundingStatus: data.fundingStatus
                    };
                });
                renderCombinedPrograms();
            }, error => console.error("Error listening to programs collection:", error));

            // Listener for programs from funding applications
            const qApplications = query(applicationsCol, orderBy("createdAt", "desc"));
            onSnapshot(qApplications, (snapshot) => {
                programsFromApplications = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.purpose,
                        type: data.category,
                        startDate: data.programDate,
                        endDate: null, // Applications don't have an end date
                        fundingStatus: data.status
                    };
                });
                renderCombinedPrograms();
            }, error => console.error("Error listening to applications collection:", error));
        };
    </script>
</body>
</html>
