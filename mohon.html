<!DOCTYPE html>
<html lang="ms" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Permohonan PIBG | SK Pulau Melayu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-3">
                <img src="https://placehold.co/40x40/4f46e5/ffffff?text=SKPM" alt="Logo SK Pulau Melayu" class="h-10 w-10 rounded-md">
                <span class="text-xl font-bold text-slate-900">PIBG SK Pulau Melayu</span>
            </a>
            <div class="flex space-x-8">
                <a href="index.html" class="text-slate-600 hover:text-indigo-600 font-semibold">Kembali ke Laman Utama</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">Analisis & Semakan Permohonan</h1>
            <p class="mt-1 text-slate-500">Papan pemuka untuk ringkasan dan perincian permohonan dana PIBG.</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <!-- Total Applications -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 flex items-center space-x-4">
                <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500">Jumlah Permohonan</p>
                    <p id="total-apps" class="text-2xl font-bold text-slate-900">0</p>
                </div>
            </div>
             <!-- Approved -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 flex items-center space-x-4">
                <div class="bg-green-100 text-green-600 p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500">Diluluskan</p>
                    <p id="total-approved" class="text-2xl font-bold text-slate-900">0</p>
                </div>
            </div>
             <!-- Pending -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 flex items-center space-x-4">
                <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500">Dalam Proses</p>
                    <p id="total-pending" class="text-2xl font-bold text-slate-900">0</p>
                </div>
            </div>
            <!-- Rejected -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 flex items-center space-x-4">
                <div class="bg-red-100 text-red-600 p-3 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500">Ditolak</p>
                    <p id="total-rejected" class="text-2xl font-bold text-slate-900">0</p>
                </div>
            </div>
            <!-- Total Amount Approved -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 flex items-center space-x-4">
                <div class="bg-blue-100 text-blue-600 p-3 rounded-full">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500">Dana Diluluskan</p>
                    <p id="total-amount" class="text-2xl font-bold text-slate-900">RM 0.00</p>
                </div>
            </div>
        </div>

        <!-- Filters and Table -->
        <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
            <!-- Filter Controls -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-4 md:space-y-0">
                <div class="flex items-center space-x-4">
                    <div>
                        <label for="month-filter" class="text-sm font-medium text-slate-700">Bulan:</label>
                        <select id="month-filter" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="all">Semua</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Mac</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Jun</option>
                            <option value="6">Julai</option>
                            <option value="7">Ogos</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Disember</option>
                        </select>
                    </div>
                     <div>
                        <label for="year-filter" class="text-sm font-medium text-slate-700">Tahun:</label>
                        <select id="year-filter" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="all">Semua</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="items-per-page" class="text-sm font-medium text-slate-700">Papar:</label>
                    <select id="items-per-page" class="mt-1 block pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option>10</option>
                        <option>20</option>
                        <option>30</option>
                    </select>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full w-full bg-white">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">No.</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Pemohon</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tujuan</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tarikh Mohon</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jumlah (RM)</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="analysis-table-body" class="divide-y divide-slate-200">
                        <!-- Loader/Data Rows here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4">
                <div>
                    <p class="text-sm text-slate-600">
                        Memaparkan <span id="page-info-start">0</span> ke <span id="page-info-end">0</span> daripada <span id="page-info-total">0</span> keputusan
                    </p>
                </div>
                <div class="flex space-x-2">
                    <button id="prev-page-btn" class="px-3 py-1 bg-white border border-slate-300 text-sm font-medium rounded-md hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Sebelumnya</button>
                    <button id="next-page-btn" class="px-3 py-1 bg-white border border-slate-300 text-sm font-medium rounded-md hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Seterusnya</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-6 py-6 text-center text-slate-500 text-sm">
            &copy; 2025 Persatuan Ibu Bapa & Guru (PIBG) SK Pulau Melayu. Hak Cipta Terpelihara.
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pibgskpm-01';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCp-DmxgF1gckJQ24dkrRNVIPUSwADS7u4",
            authDomain: "pibgskpm-01.firebaseapp.com",
            projectId: "pibgskpm-01",
            storageBucket: "pibgskpm-01.appspot.com",
            messagingSenderId: "166309223339",
            appId: "1:166309223339:web:cbe72e17506b40820c90ee"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const applicationsCol = collection(db, `/artifacts/${appId}/public/data/applications`);

        // --- State Variables ---
        let allApps = [];
        let filteredApps = [];
        let currentPage = 1;

        // --- UI Elements ---
        const monthFilter = document.getElementById('month-filter');
        const yearFilter = document.getElementById('year-filter');
        const itemsPerPageSelect = document.getElementById('items-per-page');
        const analysisTableBody = document.getElementById('analysis-table-body');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');

        // --- Authentication & Initial Load ---
        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                fetchApplications();
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                analysisTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-red-600">Gagal menyambung ke pangkalan data.</td></tr>`;
            }
        })();
        
        // --- Data Fetching and Processing ---
        const fetchApplications = () => {
             analysisTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10">Memuatkan data...</td></tr>`;
            onSnapshot(applicationsCol, (snapshot) => {
                allApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allApps.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                calculateStats();
                populateYearFilter();
                applyFiltersAndRender();
            });
        };

        const calculateStats = () => {
            document.getElementById('total-apps').textContent = allApps.length;
            
            const approvedApps = allApps.filter(app => app.status === 'Diluluskan');
            const pendingApps = allApps.filter(app => app.status === 'Dalam Proses');
            const rejectedApps = allApps.filter(app => app.status === 'Ditolak');

            document.getElementById('total-approved').textContent = approvedApps.length;
            document.getElementById('total-pending').textContent = pendingApps.length;
            document.getElementById('total-rejected').textContent = rejectedApps.length;
            
            const totalAmount = approvedApps.reduce((sum, app) => sum + app.amount, 0);
            document.getElementById('total-amount').textContent = `RM ${totalAmount.toFixed(2)}`;
        };

        const populateYearFilter = () => {
            const years = [...new Set(allApps.map(app => app.createdAt?.toDate().getFullYear()).filter(y => y))];
            years.sort((a, b) => b - a);
            
            // Clear existing options except "Semua"
            while(yearFilter.options.length > 1) {
                yearFilter.remove(1);
            }

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        };

        const applyFiltersAndRender = () => {
            const selectedMonth = monthFilter.value;
            const selectedYear = yearFilter.value;

            filteredApps = allApps.filter(app => {
                const appDate = app.createdAt?.toDate();
                if (!appDate) return false;

                const monthMatch = selectedMonth === 'all' || appDate.getMonth() == selectedMonth;
                const yearMatch = selectedYear === 'all' || appDate.getFullYear() == selectedYear;

                return monthMatch && yearMatch;
            });
            currentPage = 1;
            renderTable();
        };

        const getStatusBadge = (status) => {
            const colors = { 'Diluluskan': 'bg-green-100 text-green-800', 'Dalam Proses': 'bg-yellow-100 text-yellow-800', 'Ditolak': 'bg-red-100 text-red-800' };
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colors[status] || 'bg-slate-100 text-slate-800'}">${status}</span>`;
        };

        const renderTable = () => {
            analysisTableBody.innerHTML = '';
            if (filteredApps.length === 0) {
                analysisTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-slate-500">Tiada permohonan dijumpai.</td></tr>`;
                updatePaginationControls();
                return;
            }
            
            const itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredApps.slice(startIndex, endIndex);

            pageItems.forEach((app, index) => {
                const formattedDate = app.createdAt ? new Date(app.createdAt.seconds * 1000).toLocaleDateString('ms-MY') : 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-slate-500">${startIndex + index + 1}</td>
                    <td class="py-3 px-4 text-sm font-medium text-slate-900">${app.applicant}</td>
                    <td class="py-3 px-4 text-sm text-slate-600">${app.purpose}</td>
                    <td class="py-3 px-4 text-sm text-slate-500">${formattedDate}</td>
                    <td class="py-3 px-4 text-sm text-slate-500">${app.amount.toFixed(2)}</td>
                    <td class="py-3 px-4 text-sm text-slate-500">${getStatusBadge(app.status)}</td>
                `;
                analysisTableBody.appendChild(row);
            });
            updatePaginationControls();
        };

        const updatePaginationControls = () => {
            const itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
            const totalPages = Math.ceil(filteredApps.length / itemsPerPage);

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

            const start = filteredApps.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
            const end = Math.min(currentPage * itemsPerPage, filteredApps.length);
            
            document.getElementById('page-info-start').textContent = start;
            document.getElementById('page-info-end').textContent = end;
            document.getElementById('page-info-total').textContent = filteredApps.length;
        };
        
        // --- Event Listeners ---
        monthFilter.addEventListener('change', applyFiltersAndRender);
        yearFilter.addEventListener('change', applyFiltersAndRender);
        itemsPerPageSelect.addEventListener('change', () => {
            currentPage = 1;
            renderTable();
        });
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });
        nextPageBtn.addEventListener('click', () => {
            const itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
            const totalPages = Math.ceil(filteredApps.length / itemsPerPage);
            if(currentPage < totalPages){
                currentPage++;
                renderTable();
            }
        });

    </script>
</body>
</html>
